# ModernCMS シングルテナント版 PRD（プロダクト要求仕様）

## 0. 背景と全体像

### 0.1 ModernCMSとは？
ModernCMSは、技術ブログやコース、有料記事販売に特化した、AI時代の開発スタイルに最適化されたCMSです。MDXとJSONによるGitHubベースのコンテンツ管理、Reactコンポーネント対応、決済・アクセス制御、Vercelによるエッジ配信を特徴とします。

### 0.2 構成要素の説明（A1 / A2 / C1）
| パート | 名称 | 役割 |
|--------|------|------|
| **A1** | modern-web (Next.js) | 動的なWebアプリ。認証・決済・コンテンツ配信・Webhook処理・ステージング環境などを担う中核機能。 |
| **A2** | modern-astro-web (Astro) | 公開記事のみを静的HTMLでビルド・エクスポート。CDNホスティングやオフライン利用などが目的（※シングルテナント版では削除）。 |
| **C1** | modern-editor-client (GitHub) | テナントごとのコンテンツ・設定管理用リポジトリ。MDX/JSONで構成され、AIツール（Cursor、Claude等）との親和性を前提とする。 |

---

## 1. 概要（Executive Summary）

### 1.1 目的
本プロジェクトは、ModernCMS のマルチテナント設計をベースとしつつ、自社利用およびVIP顧客向けに最適化した「シングルテナント版 CMS」の構築を目的とする。運用・構成の簡素化を図る一方で、将来的なマルチテナント統合への再拡張が可能なアーキテクチャを維持する。

### 1.2 想定ユースケース
- 自社内での技術ブログ・コース・有料記事配信
- チーム内でのGitHub連携によるコンテンツ運用
- テスト目的でのStripe決済導入
- ステージング環境を活用したコンテンツレビュー

### 1.3 システム構成
- A1（modern-web）のみを使用（Astro静的エクスポート＝A2は削除）
- GitHubリポジトリ構成はC1テンプレートを踏襲
- Vercel上にホスティング（Preview環境含む）

---

## 2. 主な要件と簡略化ポリシー

### 2.1 テナント・ドメイン管理
| 項目 | 方針 |
|------|------|
| テナント構成 | 固定1テナント |
| ドメイン | 固定（例：mycms.example.com） |
| middleware.ts | `TENANT_ID`を.envで固定、hostベース解決は削除/コメントアウト |
| テナント識別関数 | `getCurrentTenant()` 等の抽象層は維持（将来拡張用） |

### 2.2 DB構成（Tursoの詳細含む）
| 項目 | 方針 |
|------|------|
| データベース | Tursoを利用（本番とステージング） |
| DB接続切替 | `.env`により手動指定（マルチテナント切替ロジック削除） |
| Neon DB | 不使用（マルチテナント管理テーブルを排除） |

#### Turso内のテーブル構成
Turso（SQLite互換）に保存される主なテーブルとその役割は以下の通り：

| テーブル名 | 用途 |
|-------------|------|
| `contents` | GitHub上のMDXファイルと対応。記事・ページの本文・メタ情報を保持。GitHub Webhook同期対象。 |
| `settings` | GitHub上のJSON設定ファイルと対応。サイト構成・テーマ・ナビゲーションなど。GitHub Webhook同期対象。 |
| `users` | Clerk連携により生成されるエンドユーザー情報（メールアドレス、Clerk ID等）。 |
| `products` | Stripe連携により作成される商品マスタ。価格、関連コンテンツ、商品タイプ等を保持。Webhookで同期。 |
| `orders` | Stripe決済後に生成される注文履歴。どのユーザーがどの商品を購入したかを記録。アクセス制御に使用。 |
| `access_logs` | ユーザーがどのコンテンツにアクセスしたかのログ。分析・監査用途。 |

#### データ同期の安全性について
GitHubから `main` ブランチへマージされると、Webhookにより `contents` および `settings` のみが `mainDB` に upsert（追記または更新）されます。**`orders` や `products` などの決済データは同期対象外**であり、消える・上書きされることはありません。

このため、ステージングDB（branchDB）での編集を本番DB（mainDB）へ反映しても、決済関連データが失われる心配はありません。

### 2.3 GitHub連携
| 項目 | 方針 |
|------|------|
| コンテンツ管理 | 自社チームが1つのGitHubリポジトリで管理（C1テンプレート使用） |
| Webhook URL | `/api/webhooks/github/[tenantId]`形式を維持しつつ、tenantIdは.envと突合確認するのみ |
| PRプレビュー | Vercel Previewを利用、Basic認証を追加予定 |
| PRマージ後 | 対応するステージング環境は自動削除 |

### 2.4 認証・権限
| 項目 | 方針 |
|------|------|
| 認証基盤 | Clerkをそのまま使用（1アプリ） |
| ロール設計 | `admin` / `reader` の2ロールのみで運用 |
| SUPER_ADMIN_ID | `.env`で明示設定（publicMetadataは利用しない） |

### 2.5 決済・Paywall
| 項目 | 方針 |
|------|------|
| Stripe連携 | 維持（自社テスト用） |
| Webhookエンドポイント | `/api/webhooks/stripe/[tenantId]`形式を維持、tenantIdは.envで一致確認 |
| orders・products | Tursoに保存、viewer側Paywallで参照 |

### 2.6 UI構成
| 項目 | 方針 |
|------|------|
| SaaS管理画面（/admin） | 削除 |
| テナント管理画面（/manage） | 基本は不要（記事管理はGitHub） |
| コンテンツ管理 | すべてGitHub + PRで運用（ローカル編集前提） |

---

## 3. 実装上の留意点（将来の再拡張を見据えた配慮）

- ドメインやテナントのハードコードは避け、`.env` で柔軟に切替可能な設計にしておく
- `getCurrentTenant()` 等、将来切り替え可能な抽象化レイヤーは保持
- Webhookエンドポイント構造（パス形式）はマルチテナント対応型のまま維持
- `middleware.ts` のドメイン判定ロジックはコメントアウトで残す
- SaaS管理機能やNeon DB周りのコードはフォルダごと分離・削除可能に

---

## 4. 除外機能（MVPでは実装しない）
- A2（Astro静的エクスポート）
- 複数テナント管理UI（/admin）
- カスタムドメイン設定（常に固定ドメイン）
- 決済管理画面（売上確認など）
- 高度なアクセス制御（購読プラン、定期購読など）

---

## 5. 次ステップ（フェーズ分割での開発計画）
ModernCMSシングルテナントの開発は、以下の6フェーズに分けて進める。
各フェーズはそれ単体で実行可能かつ検証可能な機能単位で構成し、段階的にプロダクト完成度を高める。

### Phase 1: コンテンツ配信の最小構成
- A1（Next.js）セットアップ、middleware簡略化
- Turso本番DB（mainDB）用意
- GitHub（C1）連携＋Webhook設定
- GitHubからの同期で記事表示

🧪 記事が公開され、編集→マージ→反映まで確認可能

---

### Phase 2: ステージング環境の構築
- ブランチpush時のbranchDB自動生成
- Vercel Preview環境の表示確認
- Basic認証を自動付与
- PRマージ後のクリーンアップ（branchDB削除）

🧪 Preview URLで内容確認→マージ→本番反映が動作

---

### Phase 3: 認証（Clerk）導入
- Clerkの設定・ログイン/サインアップ実装
- `admin` / `reader` ロール分け（env管理）
- コンテンツの閲覧権限分離（LoginWall）

🧪 認証あり・なしでの表示切替が動作

---

### Phase 4: 有料コンテンツ販売（Stripe連携）
- Stripe連携設定（APIキー・Webhook）
- Checkout導線と決済画面
- Webhookでのorders登録・Paywall解放

🧪 未購入では閲覧不可 → 決済後は即解放される

---

### Phase 5: アクセスログと分析導入
- `access_logs` テーブルへの記録処理
- IP・path・user_id 等の保存
- 分析や可視化の基礎データ準備

🧪 記事アクセス後、ログに1件記録されている

---

### Phase 6: 運用最適化と初期リリース
- .env整備・エラー/404画面設計
- SEO関連設定（OGP・title/meta）
- キャッシュや軽量化調整（Edge Cache等）
- 利用マニュアル・初期運用ドキュメント

🧪 安定動作・ドキュメント完備で初回リリース可能

